<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اسکن و وضعیت غذا</title>

<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
  :root {
    --primary-color: #007bff;
    --success-color: #28a745;
    --error-color: #dc3545;
    --light-bg: #f8f9fa;
    --dark-text: #343a40;
    --light-text: #f8f9fa;
    --border-radius: 12px;
    --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  * { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
    font-family: 'Vazirmatn', sans-serif; 
  }

  body {
    background-color: var(--light-bg);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    color: var(--dark-text);
  }

  .container {
    width: 100%;
    max-width: 450px;
    text-align: center;
  }
  
  h2 {
    font-size: 1.6rem;
    color: var(--dark-text);
    margin-bottom: 25px;
  }

  video {
    width: 100%;
    border: 4px solid #fff;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 25px;
    background-color: #000;
  }

  .result-card {
    width: 100%;
    background-color: #fff;
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--box-shadow);
    min-height: 150px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: all 0.4s ease-in-out;
    text-align: right;
  }

  .result-card .message {
    font-size: 1.2rem;
    color: #6c757d;
    font-weight: 500;
    text-align: center;
  }
  
  .result-card.found {
    border-top: 5px solid var(--primary-color);
  }

  .result-card.not-found {
    border-top: 5px solid var(--error-color);
    background-color: #fff3f3;
  }

  .user-info h3 {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: 20px;
    text-align: center;
  }
  
  .meal-section h4 {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
  }
  .meal-status {
    list-style: none;
    padding: 0;
    width: 100%;
    margin-bottom: 20px;
  }
  .meal-status li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    margin: 8px 0;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 500;
  }
  .meal-status .status-ok {
    background-color: #e9f7ec;
    color: var(--success-color);
  }
  .meal-status .status-no {
    background-color: #fdeeee;
    color: var(--error-color);
  }
  
  hr {
    border: 0;
    height: 1px;
    background-color: #e9ecef;
    margin: 25px 0;
  }

  .details-section h4 {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
  }
  .details-list {
    list-style: none;
    padding: 0;
  }
  .details-list li {
    padding: 10px 5px;
    font-size: 1rem;
    border-bottom: 1px solid #f1f1f1;
  }
  .details-list li:last-child {
    border-bottom: none;
  }
  .details-list li b {
    color: var(--primary-color);
    margin-left: 8px;
  }
</style>
</head>
<body>

<main class="container">
  <h2>بارکد را مقابل دوربین قرار دهید</h2>
  <video id="video" autoplay playsinline></video>
  <div id="result" class="result-card">
    <div id="message" class="message">در حال بارگذاری دوربین...</div>
  </div>
</main>

<script>
  const video = document.getElementById('video');
  const resultCard = document.getElementById('result');
  const messageEl = document.getElementById('message');

  const jsonUrl = "https://raw.githubusercontent.com/sarvari1378/QRCode_Resolver/main/Data/Users.json";

  let users = [];
  let lastDecoded = null;
  let scanCooldown = 3000;

  if (!('BarcodeDetector' in window)) {
    displayMessage("مرورگر شما از اسکن بارکد پشتیبانی نمی‌کند.", "error");
  } else {
    const barcodeDetector = new BarcodeDetector({
      formats: ['code_128', 'ean_13', 'qr_code']
    });

    function displayMessage(text, type = 'info') {
      messageEl.textContent = text;
      resultCard.innerHTML = '';
      resultCard.appendChild(messageEl);
      resultCard.classList.remove('found', 'not-found');
      if (type === 'error') {
        resultCard.classList.add('not-found');
      }
    }

    // *** کل تغییرات اینجاست ***
    function displayUserInfo(user) {
      if (!user) {
        displayMessage("کاربر با این شناسه یافت نشد.", "error");
        return;
      }
      
      resultCard.classList.remove('not-found');
      resultCard.classList.add('found');

      // ۱. دسترسی به کلیدها با براکت و خواندن مقدار رشته
      const wednesdayStatus = user["ناهار چهارشنبه"]; // مثال: "دارد" یا "ندارد"
      const thursdayStatus = user["ناهار پنجشنبه"];

      // ۲. مقایسه دقیق رشته با "دارد"
      const hasWednesdayMeal = wednesdayStatus === "دارد";
      const hasThursdayMeal = thursdayStatus === "دارد";
      
      let otherDetailsHtml = '';
      // حلقه برای استخراج سایر اطلاعات
      for (const [key, value] of Object.entries(user)) {
        // ۳. به‌روزرسانی فیلتر برای نادیده گرفتن کلیدهای فارسی
        if (['id', 'Name', 'ناهار چهارشنبه', 'ناهار پنجشنبه'].includes(key)) {
          continue;
        }
        otherDetailsHtml += `<li><b>${key}:</b> ${value || "ثبت نشده"}</li>`;
      }

      const html = `
        <div class="user-info">
          <h3>${user.Name}</h3>

          <div class="meal-section">
            <h4>وضعیت رزرو غذا</h4>
            <ul class="meal-status">
              <li class="${hasWednesdayMeal ? 'status-ok' : 'status-no'}">
                <span>غذای چهارشنبه</span>
                <span>${hasWednesdayMeal ? '✅ دارد' : '❌ ندارد'}</span>
              </li>
              <li class="${hasThursdayMeal ? 'status-ok' : 'status-no'}">
                <span>غذای پنج‌شنبه</span>
                <span>${hasThursdayMeal ? '✅ دارد' : '❌ ندارد'}</span>
              </li>
            </ul>
          </div>
          
          ${otherDetailsHtml ? '<hr>' : ''}
          
          ${otherDetailsHtml ? `
          <div class="details-section">
            <h4>سایر اطلاعات</h4>
            <ul class="details-list">
              ${otherDetailsHtml}
            </ul>
          </div>
          ` : ''}
        </div>
      `;
      resultCard.innerHTML = html;
    }
    
    async function loadUsers() {
      try {
        const res = await fetch(jsonUrl);
        if (!res.ok) throw new Error(`خطای شبکه: ${res.status}`);
        const data = await res.json();
        users = data.map((item, index) => ({ id: index + 1, ...item }));
        displayMessage("لطفاً بارکد را اسکن کنید.");
      } catch (e) {
        displayMessage(`خطا در بارگذاری داده‌ها: ${e.message}`, 'error');
      }
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          requestAnimationFrame(scanFrame);
        };
      } catch (e) {
        console.error("Camera Error:", e);
        displayMessage(`خطا در دسترسی به دوربین: ${e.message}`, 'error');
      }
    }

    async function scanFrame() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        try {
          const detectedBarcodes = await barcodeDetector.detect(video);

          if (detectedBarcodes.length > 0) {
            const barcodeData = detectedBarcodes[0].rawValue;

            if (barcodeData !== lastDecoded) {
              lastDecoded = barcodeData;
              let id = NaN;

              if (barcodeData && barcodeData.includes('_')) {
                const parts = barcodeData.split('_');
                const numberPart = parts[parts.length - 1];
                id = parseInt(numberPart, 10);
              }

              if (!isNaN(id)) {
                const user = users.find(u => u.id === id);
                displayUserInfo(user);
              } else {
                displayMessage(`فرمت بارکد (${barcodeData}) معتبر نیست.`, 'error');
              }

              setTimeout(() => {
                lastDecoded = null;
              }, scanCooldown);
            }
          }
        } catch (e) {
          console.error("Barcode detection failed:", e);
        }
      }
      requestAnimationFrame(scanFrame);
    }

    (async () => {
      await loadUsers();
      await startCamera();
    })();
  }
</script>

</body>
</html>
