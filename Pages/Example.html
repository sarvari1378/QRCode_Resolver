<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<title>اسکنر کیو آر کد ساده</title>
<script defer src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<style>
  body {
    font-family: sans-serif; 
    text-align: center; 
    direction: rtl; 
    margin: 20px;
  }
  #reader {
    width: 320px;
    margin: 20px auto;
    border: 3px solid #0078d7;
    border-radius: 12px;
    position: relative;
  }
  #result {
    max-width: 320px;
    margin: 15px auto;
    background: #f9f9f9;
    border-radius: 8px;
    padding: 10px;
    text-align: right;
    min-height: 150px;
    border: 1px solid #ddd;
  }
</style>
</head>
<body>

<h2>کیو آر کد را مقابل دوربین قرار دهید</h2>

<div id="reader"></div>
<div id="result">منتظر اسکن کیو آر کد...</div>

<script>
window.onload = async () => {
  const jsonUrl = "https://raw.githubusercontent.com/sarvari1378/QRCode_Resolver/main/Data/Users.json";
  let users = [];
  let html5QrCode = null;

  // لود فایل JSON
  async function loadUsers() {
    try {
      const res = await fetch(jsonUrl);
      if (!res.ok) throw new Error("خطا در بارگذاری JSON");
      users = await res.json();
    } catch (e) {
      document.getElementById("result").innerText = "خطا در بارگذاری داده‌ها: " + e.message;
    }
  }

  // نمایش اطلاعات کاربر
  function displayUserInfo(decodedText) {
    const user = users.find(u => String(u.id) === String(decodedText));
    if (user) {
      let html = "<h3>اطلاعات کاربر:</h3><ul>";
      for (const [k, v] of Object.entries(user)) {
        html += `<li><b>${k}:</b> ${v || ""}</li>`;
      }
      html += "</ul>";
      document.getElementById("result").innerHTML = html;
    } else {
      document.getElementById("result").innerHTML = `<p>کاربر با شناسه <b>${decodedText}</b> یافت نشد.</p>`;
    }
  }

  // شروع اسکنر با اولین دوربین موجود
  async function startScanner() {
    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        document.getElementById("result").innerText = "هیچ دوربینی پیدا نشد.";
        return;
      }

      html5QrCode = new Html5Qrcode("reader");

      const config = {
        fps: 10,
        qrbox: 250,
        aspectRatio: 1.0,
        rememberLastUsedCamera: true
      };

      await html5QrCode.start(
        cameras[0].id, // استفاده از اولین دوربین به صورت پیش‌فرض
        config,
        (decodedText, decodedResult) => {
          displayUserInfo(decodedText);
        },
        (errorMessage) => {
          // خطاهای جزئی اسکن، می‌توان نادیده گرفت یا ثبت کرد
        }
      );

    } catch (err) {
      document.getElementById("result").innerText = "خطا در شروع اسکنر: " + err;
    }
  }

  await loadUsers();
  await startScanner();
};
</script>

</body>
</html>
